name: ðŸ³ Docker Build & Deploy

on:
  push:
    branches: [ main, master, develop ]
  release:
    types: [ published ]

env:
  # Dockeré•œåƒåç§° - GitHub Container Registryæ ¼å¼
  IMAGE_NAME: ghcr.io/zhy0504/star-savings
  # GitHub Container Registryé…ç½®
  GHCR_REGISTRY: ghcr.io
  # é•œåƒæ ‡ç­¾
  IMAGE_TAG: ${{ github.sha }}

jobs:
  # ðŸ³ Dockerå¤šå¹³å°æž„å»º
  docker-build:
    name: ðŸ—ï¸ Dockeræž„å»º
    runs-on: ubuntu-latest

    strategy:
      matrix:
        platform:
          - linux/amd64
          - linux/arm64

    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ðŸŸ¢ è®¾ç½®Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ðŸ” ç™»å½•GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.GHCR_REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: ðŸ³ æž„å»ºå¹¶æŽ¨é€Dockeré•œåƒ
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: ${{ matrix.platform }}
        push: true
        tags: |
          ${{ env.IMAGE_NAME }}:${{ github.sha }}
          ${{ env.IMAGE_NAME }}:latest
        labels: |
          org.opencontainers.image.title=${{ env.IMAGE_NAME }}
          org.opencontainers.image.revision=${{ github.sha }}
          org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          BUILD_DATE=${{ github.event.head_commit.timestamp }}
          VCS_REF=${{ github.sha }}

    - name: âœ… æž„å»ºæˆåŠŸé€šçŸ¥
      run: |
        echo "ðŸŽ‰ Dockeré•œåƒæž„å»ºæˆåŠŸï¼"
        echo "ðŸ“¦ é•œåƒæ ‡ç­¾: ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}"

  # ðŸš€ ç®€å•éƒ¨ç½²æµ‹è¯•
  deploy-test:
    name: ðŸ§ª éƒ¨ç½²æµ‹è¯•
    runs-on: ubuntu-latest
    needs: docker-build
    if: github.ref == 'refs/heads/main'

    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ðŸ³ å¯åŠ¨æµ‹è¯•å®¹å™¨
      run: |
        echo "ðŸš€ å¯åŠ¨Dockerå®¹å™¨è¿›è¡Œæµ‹è¯•..."

        # åˆ›å»ºä¸´æ—¶æµ‹è¯•é…ç½®
        cat > docker-compose.test.yml << EOF
        version: '3.8'
        services:
          backend:
            image: ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
            container_name: star-backend-test
            ports:
              - "9000:9000"
            volumes:
              - ./backend/storage:/var/www/html/storage
            environment:
              - APP_ENV=testing
              - APP_DEBUG=true
              - DB_CONNECTION=sqlite
              - DB_DATABASE=/var/www/html/storage/app/database.sqlite

          nginx:
            image: nginx:alpine
            container_name: star-nginx-test
            ports:
              - "8080:80"
            volumes:
              - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
            depends_on:
              - backend
        EOF

        # ç­‰å¾…å®¹å™¨å¯åŠ¨
        sleep 30

    - name: ðŸ§ª è¿è¡ŒåŸºæœ¬æµ‹è¯•
      run: |
        echo "ðŸ” æµ‹è¯•å®¹å™¨æ˜¯å¦æ­£å¸¸è¿è¡Œ..."

        # æµ‹è¯•å®¹å™¨æ˜¯å¦è¿è¡Œ
        if docker ps | grep star-backend-test; then
          echo "âœ… åŽç«¯å®¹å™¨è¿è¡Œæ­£å¸¸"
        else
          echo "âŒ åŽç«¯å®¹å™¨å¯åŠ¨å¤±è´¥"
          docker logs star-backend-test
          exit 1
        fi

        if docker ps | grep star-nginx-test; then
          echo "âœ… Nginxå®¹å™¨è¿è¡Œæ­£å¸¸"
        else
          echo "âŒ Nginxå®¹å™¨å¯åŠ¨å¤±è´¥"
          docker logs star-nginx-test
          exit 1
        fi

    - name: ðŸ§¹ æ¸…ç†æµ‹è¯•å®¹å™¨
      if: always()
      run: |
        docker-compose -f docker-compose.test.yml down -v
        docker system prune -f

    - name: ðŸŽ‰ æµ‹è¯•å®Œæˆ
      run: |
        echo "ðŸŽ‰ Dockeré•œåƒæµ‹è¯•å®Œæˆï¼"
        echo "ðŸ“¦ å¯ç”¨é•œåƒ: ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}"
        echo "ðŸš€ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤éƒ¨ç½²:"
        echo "   docker run -d -p 8080:80 ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}"