name: ðŸ³ Docker Build & Deploy

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  release:
    types: [ published ]

env:
  # Dockeré•œåƒåç§° - ä½¿ç”¨ç®€å•çš„å‘½åé¿å…ç»„ç»‡åŒ…é—®é¢˜
  IMAGE_NAME: zhy0504/star-savings
  # Docker Hubé…ç½®
  DOCKER_REGISTRY: docker.io
  # é•œåƒæ ‡ç­¾
  IMAGE_TAG: ${{ github.sha }}
  # æœ€æ–°æ ‡ç­¾
  LATEST_TAG: latest

jobs:
  # ðŸ” ä»£ç è´¨é‡æ£€æŸ¥
  quality-check:
    name: ðŸ§ª ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ðŸŸ¢ è®¾ç½®Node.jsçŽ¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: ðŸ“¦ å®‰è£…å‰ç«¯ä¾èµ–
      working-directory: ./frontend
      run: npm ci

    - name: ðŸ” æ£€æŸ¥å‰ç«¯ä»£ç 
      working-directory: ./frontend
      run: |
        npm run build
        echo "âœ… å‰ç«¯æž„å»ºæˆåŠŸ"

    - name: ðŸ” æ£€æŸ¥Dockeræ–‡ä»¶è¯­æ³•
      run: |
        docker --version
        echo "âœ… Dockerå¯ç”¨"

    - name: ðŸ“ æ£€æŸ¥é…ç½®æ–‡ä»¶
      run: |
        # æ£€æŸ¥nginxé…ç½®
        nginx -t -c $(pwd)/nginx.conf || echo "âš ï¸ nginxé…ç½®æ£€æŸ¥è·³è¿‡"

        # æ£€æŸ¥docker-composeæ–‡ä»¶
        docker-compose -f docker-compose.yml config || echo "âŒ docker-composeé…ç½®æœ‰è¯¯"
        echo "âœ… é…ç½®æ–‡ä»¶æ£€æŸ¥å®Œæˆ"

  # ðŸ³ Dockerå¤šå¹³å°æž„å»º
  docker-build:
    name: ðŸ—ï¸ Dockeræž„å»º
    runs-on: ubuntu-latest
    needs: quality-check
    if: github.event_name != 'pull_request'

    strategy:
      matrix:
        platform:
          - linux/amd64
          - linux/arm64

    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ðŸŸ¢ è®¾ç½®Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ðŸ” ç™»å½•Docker Hub
      uses: docker/login-action@v3
      with:
        registry: ${{ env.DOCKER_REGISTRY }}
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: ðŸ³ æž„å»ºå¹¶æŽ¨é€Dockeré•œåƒ
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: ${{ matrix.platform }}
        push: true
        tags: |
          ${{ env.IMAGE_NAME }}:${{ github.sha }}
          ${{ env.IMAGE_NAME }}:latest
        labels: |
          org.opencontainers.image.title=${{ env.IMAGE_NAME }}
          org.opencontainers.image.revision=${{ github.sha }}
          org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          BUILD_DATE=${{ github.event.head_commit.timestamp }}
          VCS_REF=${{ github.sha }}

    - name: âœ… æž„å»ºæˆåŠŸé€šçŸ¥
      run: |
        echo "ðŸŽ‰ Dockeré•œåƒæž„å»ºæˆåŠŸï¼"
        echo "ðŸ“¦ é•œåƒæ ‡ç­¾: ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}"

  # ðŸ§ª é›†æˆæµ‹è¯•
  integration-test:
    name: ðŸ§ª é›†æˆæµ‹è¯•
    runs-on: ubuntu-latest
    needs: docker-build
    if: github.event_name != 'pull_request'

    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ðŸ³ å¯åŠ¨æµ‹è¯•å®¹å™¨
      run: |
        echo "ðŸš€ å¯åŠ¨Dockerå®¹å™¨è¿›è¡Œæµ‹è¯•..."

        # åˆ›å»ºä¸´æ—¶æµ‹è¯•é…ç½®
        cat > docker-compose.test.yml << EOF
        version: '3.8'
        services:
          backend:
            image: ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
            container_name: star-backend-test
            volumes:
              - ./backend/storage:/var/www/html/storage
            environment:
              - APP_ENV=testing
              - APP_DEBUG=true
              - DB_CONNECTION=sqlite
              - DB_DATABASE=/var/www/html/storage/app/database.sqlite
            restart: unless-stopped

          nginx:
            image: nginx:alpine
            container_name: star-nginx-test
            ports:
              - "8080:80"
            volumes:
              - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
              - ./.htpasswd:/etc/nginx/.htpasswd:ro
            depends_on:
              - backend
            restart: unless-stopped
        EOF

        # ç­‰å¾…å®¹å™¨å¯åŠ¨
        sleep 30

    - name: ðŸ§ª è¿è¡ŒAPIæµ‹è¯•
      run: |
        echo "ðŸ” æµ‹è¯•APIå¥åº·æ£€æŸ¥..."

        # æµ‹è¯•å¥åº·æ£€æŸ¥ç«¯ç‚¹
        response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/api/health)
        if [ "$response" = "200" ]; then
          echo "âœ… APIå¥åº·æ£€æŸ¥é€šè¿‡"
        else
          echo "âŒ APIå¥åº·æ£€æŸ¥å¤±è´¥ï¼ŒçŠ¶æ€ç : $response"
          exit 1
        fi

        # æµ‹è¯•å‰ç«¯é¡µé¢
        response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080)
        if [ "$response" = "200" ]; then
          echo "âœ… å‰ç«¯é¡µé¢è®¿é—®æ­£å¸¸"
        else
          echo "âš ï¸ å‰ç«¯é¡µé¢å¯èƒ½éœ€è¦è®¤è¯"
        fi

    - name: ðŸ§¹ æ¸…ç†æµ‹è¯•å®¹å™¨
      if: always()
      run: |
        docker-compose -f docker-compose.test.yml down -v
        docker system prune -f

  # ðŸš€ éƒ¨ç½²åˆ°ç”Ÿäº§çŽ¯å¢ƒ
  deploy-production:
    name: ðŸš€ éƒ¨ç½²åˆ°ç”Ÿäº§çŽ¯å¢ƒ
    runs-on: ubuntu-latest
    needs: [docker-build, integration-test]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    environment: production

    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ðŸš€ éƒ¨ç½²åˆ°ç”Ÿäº§æœåŠ¡å™¨
      run: |
        echo "ðŸŽ¯ å‡†å¤‡éƒ¨ç½²åˆ°ç”Ÿäº§çŽ¯å¢ƒ..."
        echo "ðŸ“¦ ä½¿ç”¨é•œåƒ: ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}"

        # è¿™é‡Œå¯ä»¥æ·»åŠ ä½ çš„éƒ¨ç½²è„šæœ¬
        # ä¾‹å¦‚ï¼šSSHåˆ°æœåŠ¡å™¨ï¼Œæ‹‰å–æœ€æ–°é•œåƒï¼Œé‡å¯å®¹å™¨ç­‰

        echo "ðŸŽ‰ éƒ¨ç½²å®Œæˆï¼"

    - name: ðŸ“§ éƒ¨ç½²é€šçŸ¥
      if: always()
      run: |
        echo "ðŸ“§ å‘é€éƒ¨ç½²é€šçŸ¥..."
        echo "ðŸ”— GitHubä»“åº“: ${{ github.repository }}"
        echo "ðŸ·ï¸ é•œåƒæ ‡ç­¾: ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}"
        echo "ðŸš€ éƒ¨ç½²çŠ¶æ€: ${{ job.status }}"

  # ðŸ·ï¸ æ›´æ–°æœ€æ–°æ ‡ç­¾
  update-latest:
    name: ðŸ·ï¸ æ›´æ–°latestæ ‡ç­¾
    runs-on: ubuntu-latest
    needs: [deploy-production]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'

    steps:
    - name: ðŸ” ç™»å½•Docker Hub
      uses: docker/login-action@v3
      with:
        registry: ${{ env.DOCKER_REGISTRY }}
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: ðŸ·ï¸ é‡æ–°æ ‡è®°ä¸ºlatest
      run: |
        docker pull ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
        docker tag ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} ${{ env.IMAGE_NAME }}:latest
        docker push ${{ env.IMAGE_NAME }}:latest
        echo "âœ… latestæ ‡ç­¾æ›´æ–°å®Œæˆ"