name: ğŸ”’ å®‰å…¨æ‰«æ

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  schedule:
    # æ¯å‘¨ä¸€å‡Œæ™¨2ç‚¹è¿è¡Œå®‰å…¨æ‰«æ
    - cron: '0 2 * * 1'

jobs:
  # ğŸ” å‰ç«¯ä¾èµ–å®‰å…¨æ‰«æ
  frontend-security:
    name: ğŸ” å‰ç«¯å®‰å…¨æ‰«æ
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸŸ¢ è®¾ç½®Node.jsç¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: ğŸ“¦ å®‰è£…å‰ç«¯ä¾èµ–
      working-directory: ./frontend
      run: npm ci

    - name: ğŸ” npmå®‰å…¨å®¡è®¡
      working-directory: ./frontend
      run: |
        npm audit --audit-level moderate
        echo "âœ… å‰ç«¯ä¾èµ–å®‰å…¨æ‰«æå®Œæˆ"

    - name: ğŸ” æ‰«ææ•æ„Ÿä¿¡æ¯
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: main
        head: HEAD

  # ğŸ” Dockeré•œåƒå®‰å…¨æ‰«æ
  docker-security:
    name: ğŸ³ Dockerå®‰å…¨æ‰«æ
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request'

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸŸ¢ è®¾ç½®Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ğŸ³ æ„å»ºDockeré•œåƒ
      uses: docker/build-push-action@v5
      with:
        context: .
        push: false
        load: true
        tags: star-savings:test
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: ğŸ” Trivyæ¼æ´æ‰«æ
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'star-savings:test'
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: ğŸ“¤ ä¸Šä¼ Trivyæ‰«æç»“æœ
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

    - name: ğŸ” å¤„ç†æ‰«æç»“æœ
      if: always()
      run: |
        echo "âœ… Trivyå®‰å…¨æ‰«æå®Œæˆ"
        echo "ğŸ“„ SARIFç»“æœæ–‡ä»¶: trivy-results.sarif"

        # æ˜¾ç¤ºæ‰«æç»“æœæ‘˜è¦
        if [ -f "trivy-results.sarif" ]; then
          echo "ğŸ“Š æ‰«æç»“æœæ–‡ä»¶å¤§å°: $(wc -c < trivy-results.sarif) å­—èŠ‚"
        else
          echo "âš ï¸ æœªç”ŸæˆSARIFç»“æœæ–‡ä»¶"
        fi

  # ğŸ“Š ä¾èµ–æ£€æŸ¥æŠ¥å‘Š
  dependency-report:
    name: ğŸ“Š ä¾èµ–æŠ¥å‘Š
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸŸ¢ è®¾ç½®Node.jsç¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: ğŸ“¦ ç”Ÿæˆä¾èµ–æŠ¥å‘Š
      working-directory: ./frontend
      run: |
        npm install
        npm ls --depth=0 > ../frontend-deps.txt

    - name: ğŸ“¤ ä¸Šä¼ ä¾èµ–æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      with:
        name: dependency-report
        path: frontend-deps.txt
        retention-days: 30

  # ğŸ›¡ï¸ é…ç½®å®‰å…¨æ£€æŸ¥
  config-security:
    name: ğŸ›¡ï¸ é…ç½®å®‰å…¨æ£€æŸ¥
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ” æ£€æŸ¥æ•æ„Ÿæ–‡ä»¶
      run: |
        echo "ğŸ” æ£€æŸ¥æ˜¯å¦åŒ…å«æ•æ„Ÿæ–‡ä»¶..."

        # æ£€æŸ¥æ˜¯å¦æœ‰ç§é’¥æ–‡ä»¶
        if [ -f "id_rsa" ] || [ -f "*.pem" ]; then
          echo "âŒ å‘ç°ç§é’¥æ–‡ä»¶ï¼"
          exit 1
        fi

        # æ£€æŸ¥æ˜¯å¦æœ‰å¯†ç æ–‡ä»¶
        if grep -r "password.*=" . --exclude-dir=node_modules --exclude-dir=.git; then
          echo "âš ï¸ å‘ç°å¯èƒ½çš„å¯†ç é…ç½®ï¼Œè¯·æ£€æŸ¥"
        fi

        # æ£€æŸ¥Dockeré…ç½®
        if grep -r "expose 22" .; then
          echo "âš ï¸ å‘ç°SSHç«¯å£æš´éœ²"
        fi

        echo "âœ… é…ç½®å®‰å…¨æ£€æŸ¥å®Œæˆ"

    - name: ğŸ” æ£€æŸ¥Dockerå®‰å…¨é…ç½®
      run: |
        echo "ğŸ” æ£€æŸ¥Dockeré…ç½®å®‰å…¨æ€§..."

        # æ£€æŸ¥æ˜¯å¦ä»¥rootç”¨æˆ·è¿è¡Œ
        if grep -q "USER root" Dockerfile; then
          echo "âš ï¸ Dockerfileä¸­ä½¿ç”¨rootç”¨æˆ·"
        else
          echo "âœ… Dockerç”¨æˆ·é…ç½®è‰¯å¥½"
        fi

        # æ£€æŸ¥æ•æ„Ÿä¿¡æ¯æŒ‚è½½
        if docker-compose config | grep -q "\.env"; then
          echo "âš ï¸ docker-composeä¸­å¯èƒ½åŒ…å«ç¯å¢ƒæ–‡ä»¶"
        fi

        echo "âœ… Dockerå®‰å…¨æ£€æŸ¥å®Œæˆ"